@inject IDialogService _dialogService
@inject IToastService _toastService

@inherits ADisposibleBaseComponent

<SfDialog Width="@ComponentWidth" Target="#body" IsModal="true" @bind-Visible="ComponentIsVisible" ShowCloseIcon="ComponentHasCloseButton" CssClass="@ComponentStyle" Header="@ComponentTitle">
    <DialogTemplates>
        <Content>
            <CascadingValue Value="this">
                <CascadingValue Value="ComponentParameters">
                    @ComponentContent
                </CascadingValue>
            </CascadingValue>
        </Content>
    </DialogTemplates>

    <DialogEvents OnOpen="DialogOpen" Closed="DialogClose" OnOverlayClick="OverlayClick"></DialogEvents>
    <DialogAnimationSettings Effect="@DialogEffect.None"></DialogAnimationSettings>
    <DialogPositionData X="@ComponentXPosition" Y="@ComponentYPosition"></DialogPositionData>
</SfDialog>

@code {
    [Parameter]
    public string XPosition { get; set; }

    [Parameter]
    public string YPosition { get; set; }

    [Parameter]
    public string Style { get; set; }

    [Parameter]
    public string Width { get; set; }

    [Parameter]
    public bool HasHeader { get; set; }

    [Parameter]
    public bool HasCloseButton { get; set; }

    [Parameter]
    public bool HasBackgroundCancel { get; set; }

    private bool ComponentIsVisible { get; set; }
    private string ComponentXPosition { get; set; }
    private string ComponentYPosition { get; set; }
    private string ComponentStyle { get; set; }
    private string ComponentWidth { get; set; }
    private bool ComponentHasBackgroundCancel { get; set; }
    private bool ComponentHasHeader { get; set; }
    private bool ComponentHasCloseButton { get; set; }
    private string ComponentTitle { get; set; }
    private RenderFragment ComponentContent { get; set; }
    private DialogParameters ComponentParameters { get; set; }


    protected override void OnInitialized()
    {
        ((DialogService)_dialogService).OnShow += ShowDialog;
        ((DialogService)_dialogService).CloseDialog += CloseDialog;

        base.OnInitialized();
    }

    public override void Dispose()
    {
        ((DialogService)_dialogService).OnShow -= ShowDialog;
        ((DialogService)_dialogService).CloseDialog -= CloseDialog;
    }

    private void ShowDialog(string title, RenderFragment content, DialogParameters parameters, DialogOptions options)
    {
        SetDialogOptions(options);

        SetTitle(title);

        ComponentContent = content;
        ComponentParameters = parameters;

        ComponentIsVisible = true;

        StateHasChanged();
    }

    private void CloseDialog()
    {
        ComponentTitle = null;
        ComponentContent = null;
        ComponentParameters = null;
        ComponentStyle = null;

        ComponentIsVisible = false;

        StateHasChanged();
    }

    private void DialogOpen(Object args)
    {

    }

    private void DialogClose(Object args)
    {

    }

    private void OnBtnClick()
    {
        ComponentIsVisible = true;
    }

    private void DlgButtonClick()
    {
        ComponentIsVisible = false;
    }

    private void OverlayClick(Object args)
    {
        if (ComponentHasBackgroundCancel == false)
            return;

        _dialogService.Cancel();
    }

    private void SetDialogOptions(DialogOptions options)
    {
        ComponentXPosition = XPosition;
        if (String.IsNullOrEmpty(options.XPosition) == false)
            ComponentXPosition = options.XPosition;

        ComponentXPosition = YPosition;
        if (String.IsNullOrEmpty(options.YPosition) == false)
            ComponentXPosition = options.YPosition;

        ComponentStyle = Style;
        if (String.IsNullOrEmpty(options.Style) == false)
            ComponentStyle = options.Style;

        ComponentWidth = Width;
        if (String.IsNullOrEmpty(options.Width) == false)
            ComponentWidth = options.Width;

        ComponentHasBackgroundCancel = HasBackgroundCancel;
        if (options.HasBackgroundCancel.HasValue)
            ComponentHasBackgroundCancel = options.HasBackgroundCancel.Value;

        ComponentHasHeader = HasHeader;
        if (options.HasHeader.HasValue)
            ComponentHasHeader = options.HasHeader.Value;

        ComponentHasCloseButton = HasCloseButton;
        if (options.HasCloseButton.HasValue)
            ComponentHasCloseButton = options.HasCloseButton.Value;
    }

    public void SetTitle(string title)
    {
        if(String.IsNullOrEmpty(title) == false)
            ComponentTitle = title;
    }
}
